---
title: "Model Evaluation"
author: "Juan Fonseca"
format: html
---

```{r}
library(tidyverse)
library(broom)
library(GWmodel)
library(brms)
library(sf)
```

## Load model data

### Data
```{r}
model_data_expanded <- st_read("03_preprocessing_files/model_data.gpkg")
model_data_noNAs<- model_data_expanded |> 
  select(flow.2022,
         flow.2023,
         centrality,
         car_avail_perc,
         total_pop_c_1:wk_pop_c_5,
         road_density) |>
  drop_na()
```

### Fitted models

```{r}
load("03_preprocessing_files/fitted_models.RData")
```

## Model Comparison

### GLM
```{r}
lapply(GLM_models,
       function(mymodel){
         summary(mymodel)
         }
       )
```


```{r}
GLM_coef <- lapply(GLM_models,
       function(mymodel){
         beta <- coef(mymodel)
         exp(confint(mymodel,level = 0.95))
       })
GLM_coef
```

```{r}
GLM_coef_df <- do.call(rbind,lapply(GLM_coef,\(x){
  y <- as.data.frame(x)
  y$id <- row.names(x)
  y$catchment <- y |> mutate(catchid=str_extract(id,"c_\\d")) |> drop_na() |> pull(catchid) |> unique()
  tibble(y) |> mutate(id = str_remove(id,paste0("_",catchment)))
}))
```

```{r}
ggplot(GLM_coef_df)+
  geom_linerange(aes(xmin =`2.5 %`,xmax = `97.5 %`, y = catchment))+
  facet_grid(.~id,scales = "free")
```

#### RMSE
```{r}
GLM_RMSE <- vapply(
  GLM_models,
  function(mymodel) {
    mean((mymodel$data$flow.2023 - mymodel$fitted.values) ^ 2) ^ 0.5
  },
  numeric(1))
```

#### AICc
```{r}
GLM_AICc <- vapply(GLM_models,
                   function(mymodel) {
                     extractAIC(mymodel)[2]
                   },
                   numeric(1)) 
```


### GWR

```{r}
GWPR_coef <- lapply(GWPR_models,
                    function(mymodel){
                      # table of GWR coefficients
                      t1 = exp(apply(mymodel$SDF@data[, 1:4], 2, summary)) |> t()
                      })
```


```{r}
GWPR_coef_df <- do.call(rbind,lapply(GWPR_coef,\(x){
  y <- as.data.frame(x)
  y$id <- row.names(x)
  y$catchment <- y |> mutate(catchid=str_extract(id,"c_\\d")) |> drop_na() |> pull(catchid) |> unique()
  tibble(y) |> mutate(id = str_remove(id,paste0("_",catchment)))
}))
```

```{r}
ggplot(GWPR_coef_df)+
  geom_linerange(aes(xmin =`1st Qu.`,xmax = `3rd Qu.`, y = catchment))+
  facet_grid(.~id,scales = "free")
```

#### RMSE
```{r}
GWPR_RMSE <- vapply(
  GWPR_models,
  function(mymodel) {
    mean((mymodel$SDF$y - mymodel$SDF$yhat) ^ 2) ^ 0.5
  },
  numeric(1))
```


#### AICc
```{r}
GWPR_AICc <- vapply(GWPR_models,
                   function(mymodel) {
                     mymodel$glms$aic
                   },
                   numeric(1)) 
```


### Bayes Model
```{r}
library(posterior)
lapply(Bayes_NBin_models,
       function(mymodel){
         mymodel |> as_draws_array() |> summarise_draws()
       })
```

```{r}
lapply(Bayes_NBin_models,plot)
```

### Null models
null model to compare with fitted models

#### GLM
```{r}
extractAIC(null.glm)[2]
```

#### GWPR
```{r}
# AICc for null GWR model
null.gwpr$glms$aic
```

#### Bayesian Negative binomial
```{r}

```



